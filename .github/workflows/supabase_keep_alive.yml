name: Supabase Keep Alive

on:
  schedule:
    - cron: '0 8 */3 * *'   # Every 3 days at 08:00 UTC
    - cron: '0 20 */3 * *'  # Every 3 days at 20:00 UTC (double ping)
  workflow_dispatch:

jobs:
  keep-alive:
    name: Ping Supabase with real DB activity
    runs-on: ubuntu-latest

    steps:
      - name: üõí Query products table
        run: |
          RESPONSE=$(curl -s -o /tmp/products.json -w "%{http_code}" \
            -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/product?select=id,title,price&limit=5" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          echo "Products query status: $RESPONSE"
          cat /tmp/products.json
          [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ] && echo "‚úÖ Products OK" || (echo "‚ùå Products failed" && exit 1)

      - name: üóÇÔ∏è Query categories table
        run: |
          RESPONSE=$(curl -s -o /tmp/categories.json -w "%{http_code}" \
            -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/category?select=id,name,slug&limit=5" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          echo "Categories query status: $RESPONSE"
          cat /tmp/categories.json
          [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ] && echo "‚úÖ Categories OK" || (echo "‚ùå Categories failed" && exit 1)

      - name: üì¶ Query orders table
        run: |
          RESPONSE=$(curl -s -o /tmp/orders.json -w "%{http_code}" \
            -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/order?select=id,status,totalPrice&limit=5&order=created_at.desc" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          echo "Orders query status: $RESPONSE"
          cat /tmp/orders.json
          [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ] && echo "‚úÖ Orders OK" || (echo "‚ùå Orders failed" && exit 1)

      - name: üß© Query order_items table
        run: |
          RESPONSE=$(curl -s -o /tmp/order_items.json -w "%{http_code}" \
            -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/order_item?select=id,quantity,product,order&limit=5" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          echo "Order items query status: $RESPONSE"
          cat /tmp/order_items.json
          [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ] && echo "‚úÖ Order Items OK" || (echo "‚ùå Order Items failed" && exit 1)

      - name: üë• Query users table
        run: |
          RESPONSE=$(curl -s -o /tmp/users.json -w "%{http_code}" \
            -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/users?select=id,email,type&limit=5" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          echo "Users query status: $RESPONSE"
          cat /tmp/users.json
          [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ] && echo "‚úÖ Users OK" || (echo "‚ùå Users failed" && exit 1)

      - name: üîó Query products with category JOIN
        run: |
          RESPONSE=$(curl -s -o /tmp/products_join.json -w "%{http_code}" \
            -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/product?select=id,title,price,category(id,name,slug)&limit=5" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json")
          echo "Products+Category JOIN status: $RESPONSE"
          cat /tmp/products_join.json
          [ "$RESPONSE" -ge 200 ] && [ "$RESPONSE" -lt 300 ] && echo "‚úÖ JOIN query OK" || (echo "‚ùå JOIN query failed" && exit 1)

      - name: üìä Summary
        run: |
          echo "========================================="
          echo "‚úÖ All Supabase tables queried successfully"
          echo "üïê Timestamp: $(date -u)"
          echo "========================================="